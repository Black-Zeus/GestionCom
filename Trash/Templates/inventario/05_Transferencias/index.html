<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚚 Transferencias de Mercadería - Sistema de Inventario</title>
    <meta name="description" content="Módulo de transferencias entre bodegas con workflow completo de envío y recepción">
    <meta name="author" content="Sistema de Inventario">
    
    <!-- Estilos -->
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="extra.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E🚚%3C/text%3E%3C/svg%3E">
</head>

<body>
    <!-- Contenedor Principal -->
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🚚 Transferencias de Mercadería</h1>
            <div class="user-info">
                <div><strong>Usuario:</strong> Juan Pérez - Jefe de Bodega</div>
                <div id="current-date-time"></div>
            </div>
        </div>

        <!-- Navegación Principal -->
        <div class="transfers-navigation">
            <h3>📋 Centro de Control de Transferencias</h3>
            <div class="transfers-tabs" id="transfers-tabs">
                <button class="transfer-tab active" data-view="ENVIAR">
                    <span class="tab-icon">📤</span>
                    <span>Enviar</span>
                </button>
                <button class="transfer-tab" data-view="RECIBIR">
                    <span class="tab-icon">📥</span>
                    <span>Recibir</span>
                    <span class="tab-badge">2</span>
                </button>
                <button class="transfer-tab" data-view="REPORTES">
                    <span class="tab-icon">📊</span>
                    <span>Reportes</span>
                </button>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; font-size: 0.9em; color: #6c757d;">
                <div><strong>Sistema:</strong> Transferencias v2.1.0</div>
                <div><strong>Modo:</strong> Tiempo Real</div>
                <div><strong>Última Sync:</strong> <span id="last-sync">--:--:--</span></div>
                <div><strong>Estado:</strong> <span style="color: #28a745;">🟢 Conectado</span></div>
            </div>
        </div>

        <!-- KPIs Principales -->
        <div class="transfers-kpis" id="transfers-kpis">
            <!-- Los KPIs se cargan dinámicamente -->
            <div class="transfer-kpi-card info">
                <div class="kpi-icon">🚚</div>
                <div class="kpi-header">
                    <h4 class="kpi-title">En Tránsito</h4>
                </div>
                <div class="kpi-value">--</div>
                <p class="kpi-subtitle">Cargando...</p>
                <div class="kpi-trend trend-neutral">
                    <span>⏳ Inicializando</span>
                </div>
            </div>
            
            <div class="transfer-kpi-card warning">
                <div class="kpi-icon">📥</div>
                <div class="kpi-header">
                    <h4 class="kpi-title">Pendientes</h4>
                </div>
                <div class="kpi-value">--</div>
                <p class="kpi-subtitle">Cargando...</p>
                <div class="kpi-trend trend-neutral">
                    <span>⏳ Inicializando</span>
                </div>
            </div>
            
            <div class="transfer-kpi-card urgent">
                <div class="kpi-icon">⚡</div>
                <div class="kpi-header">
                    <h4 class="kpi-title">Urgentes</h4>
                </div>
                <div class="kpi-value">--</div>
                <p class="kpi-subtitle">Cargando...</p>
                <div class="kpi-trend trend-neutral">
                    <span>⏳ Inicializando</span>
                </div>
            </div>
            
            <div class="transfer-kpi-card success">
                <div class="kpi-icon">📅</div>
                <div class="kpi-header">
                    <h4 class="kpi-title">Hoy</h4>
                </div>
                <div class="kpi-value">--</div>
                <p class="kpi-subtitle">Cargando...</p>
                <div class="kpi-trend trend-neutral">
                    <span>⏳ Inicializando</span>
                </div>
            </div>
        </div>

        <!-- Contenido Principal -->
        <div id="transfers-content">
            <!-- El contenido se carga dinámicamente según la vista seleccionada -->
            <div class="transfers-section">
                <div class="transfer-loading">
                    <div class="loading-spinner"></div>
                    <span>Inicializando módulo de transferencias...</span>
                </div>
            </div>
        </div>

        <!-- Panel de Estado del Sistema -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 25px; font-size: 0.9em; color: #6c757d;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <div>
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 8px;">🔄 Estado de Sincronización</div>
                    <div>
                        <span style="color: #28a745;">●</span> Conectado al servidor principal<br>
                        <span style="color: #007bff;">●</span> Auto-actualización: <span id="auto-refresh-status">Activa</span><br>
                        <span style="color: #6c757d;">●</span> Última actualización: <span id="last-update-time">--:--:--</span>
                    </div>
                </div>
                
                <div>
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 8px;">📊 Rendimiento del Sistema</div>
                    <div>
                        <span style="color: #17a2b8;">●</span> Tiempo de respuesta: &lt;200ms<br>
                        <span style="color: #28a745;">●</span> Base de datos: Óptima<br>
                        <span style="color: #ffc107;">●</span> Cache: Caliente
                    </div>
                </div>
                
                <div>
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 8px;">🚀 Acciones Rápidas</div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-sm btn-primary" onclick="openNewTransferModal()" title="Nueva transferencia">
                            ➕ Nueva
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="loadTransfersView()" title="Actualizar vista">
                            🔄 Refresh
                        </button>
                        <button class="btn btn-sm btn-info" onclick="exportTransfers()" title="Exportar datos">
                            📊 Exportar
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="generateDetailedReport()" title="Generar reporte">
                            📈 Reporte
                        </button>
                    </div>
                </div>
                
                <div>
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 8px;">ℹ️ Información del Módulo</div>
                    <div>
                        <strong>Versión:</strong> Transferencias v2.1.0<br>
                        <strong>Bodegas:</strong> 3 conectadas<br>
                        <strong>Sesión:</strong> <span id="session-duration">00:00:00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Informativo -->
        <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #007bff;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 10px; font-size: 1em;">📋 Workflow de Transferencias</h4>
                    <div style="font-size: 0.85em; color: #6c757d; line-height: 1.5;">
                        <div><strong>1. Crear:</strong> Selecciona productos y destino</div>
                        <div><strong>2. Enviar:</strong> Genera guía y despacha</div>
                        <div><strong>3. Rastrear:</strong> Sigue el estado en tiempo real</div>
                        <div><strong>4. Recibir:</strong> Confirma cantidades y condición</div>
                        <div><strong>5. Finalizar:</strong> Actualiza inventario automáticamente</div>
                    </div>
                </div>
                
                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 10px; font-size: 1em;">⚡ Características del Sistema</h4>
                    <div style="font-size: 0.85em; color: #6c757d; line-height: 1.5;">
                        <div>✅ <strong>Tiempo Real:</strong> Actualización automática cada 30s</div>
                        <div>✅ <strong>Validaciones:</strong> Control de stock y permisos</div>
                        <div>✅ <strong>Trazabilidad:</strong> Historial completo de cambios</div>
                        <div>✅ <strong>Objeciones:</strong> Manejo de diferencias automático</div>
                        <div>✅ <strong>Reportes:</strong> Exportación y análisis avanzado</div>
                    </div>
                </div>
                
                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 10px; font-size: 1em;">🔧 Estados de Transferencia</h4>
                    <div style="font-size: 0.85em; line-height: 1.6;">
                        <div><span class="transfer-status status-borrador">BORRADOR</span> En preparación</div>
                        <div><span class="transfer-status status-enviado">ENVIADO</span> Despachado</div>
                        <div><span class="transfer-status status-en_transito">EN TRÁNSITO</span> En camino</div>
                        <div><span class="transfer-status status-recibido_total">RECIBIDO</span> Completado</div>
                        <div><span class="transfer-status status-recibido_parcial">PARCIAL</span> Con objeciones</div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #e9ecef; color: #6c757d; font-size: 0.85em;">
                <div style="margin-bottom: 5px;">
                    <strong>🚚 Sistema de Transferencias de Mercadería</strong> | 
                    Optimizado para gestión eficiente entre bodegas
                </div>
                <div>
                    Desarrollado para el control integral de movimientos de inventario | 
                    <strong>Versión 2.1.0</strong> | 
                    Actualizado el 27 de Julio de 2024
                </div>
            </div>
        </div>
    </div>

    <!-- Container para Toasts/Notificaciones -->
    <div id="toast-container"></div>

    <!-- Scripts -->
    <script src="script.js"></script>
    
    <!-- Script para mostrar fecha/hora actual -->
    <script>
        function updateDateTime() {
            const now = new Date();
            const dateTimeElement = document.getElementById('current-date-time');
            if (dateTimeElement) {
                const options = {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                };
                dateTimeElement.textContent = now.toLocaleDateString('es-CL', options);
            }

            // Actualizar tiempo de sesión
            updateSessionTime();
            
            // Actualizar sync status
            const syncElement = document.getElementById('last-sync');
            if (syncElement) {
                syncElement.textContent = now.toLocaleTimeString('es-CL');
            }
        }
        
        let sessionStartTime = new Date();
        function updateSessionTime() {
            const now = new Date();
            const diffMs = now - sessionStartTime;
            const hours = Math.floor(diffMs / (1000 * 60 * 60));
            const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);
            
            const sessionElement = document.getElementById('session-duration');
            if (sessionElement) {
                sessionElement.textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        // Actualizar cada segundo
        setInterval(updateDateTime, 1000);
        updateDateTime(); // Ejecutar inmediatamente
        
        // Simular indicadores de estado
        function updateSystemStatus() {
            const refreshStatus = document.getElementById('auto-refresh-status');
            const lastUpdate = document.getElementById('last-update-time');
            
            if (refreshStatus && lastUpdate) {
                const now = new Date();
                lastUpdate.textContent = now.toLocaleTimeString('es-CL');
                
                // Alternar estado para mostrar actividad
                const statuses = ['Activa', 'Sincronizando...', 'Actualizada'];
                const currentStatus = refreshStatus.textContent;
                const nextIndex = (statuses.indexOf(currentStatus) + 1) % statuses.length;
                refreshStatus.textContent = statuses[nextIndex];
            }
        }
        
        // Actualizar estado del sistema cada 5 segundos
        setInterval(updateSystemStatus, 5000);
    </script>

    <!-- Configuraciones para mejor experiencia -->
    <script>
        // Prevenir zoom accidental
        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });
        
        // Optimización para pantallas táctiles
        document.addEventListener('touchstart', function() {}, {passive: true});
        
        // Logging de inicialización
        console.log('🚚 Módulo de Transferencias iniciado:', {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            viewport: {
                width: window.innerWidth,
                height: window.innerHeight
            },
            module: 'Transferencias v2.1.0',
            features: [
                'Tiempo Real',
                'Auto-actualización',
                'Workflow Completo',
                'Validaciones Avanzadas',
                'Sistema de Objeciones',
                'Exportación de Datos',
                'Reportes Detallados'
            ]
        });

        // Detectar modo PWA
        if (window.matchMedia('(display-mode: standalone)').matches) {
            document.body.classList.add('pwa-mode');
            console.log('📱 Ejecutándose en modo PWA');
        }

        // Manejar errores globales del módulo
        window.addEventListener('error', (e) => {
            console.error('❌ Error en módulo de transferencias:', e.error);
            
            // Mostrar notificación amigable al usuario
            const errorToast = document.createElement('div');
            errorToast.className = 'toast error';
            errorToast.innerHTML = `
                <div class="toast-icon">❌</div>
                <div class="toast-content">
                    <div class="toast-title">Error del Sistema</div>
                    <div class="toast-message">Ha ocurrido un error. El sistema intentará recuperarse automáticamente.</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            // Agregar toast al container
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                document.body.appendChild(container);
            }
            
            container.appendChild(errorToast);
            
            // Mostrar y remover automáticamente
            setTimeout(() => {
                errorToast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                errorToast.remove();
            }, 8000);
        });

        // Información de debugging para desarrollo
        window.TransfersDebug = {
            version: '2.1.0',
            loadedAt: new Date().toISOString(),
            getAppState: () => window.TransfersApp || {},
            forceRefresh: () => window.loadTransfersView && window.loadTransfersView(),
            exportDebugData: () => {
                const debugData = {
                    timestamp: new Date().toISOString(),
                    appState: window.TransfersApp || {},
                    userAgent: navigator.userAgent,
                    viewport: { width: window.innerWidth, height: window.innerHeight }
                };
                
                console.log('🐛 Debug Data:', debugData);
                return debugData;
            }
        };
    </script>

    <!-- Configuraciones de meta tags adicionales -->
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Transferencias">
    
    <!-- Configuración específica del módulo -->
    <meta name="module-name" content="Transferencias de Mercadería">
    <meta name="module-version" content="2.1.0">
    <meta name="module-description" content="Sistema completo de transferencias entre bodegas con workflow de envío y recepción">
    
    <!-- Estilos adicionales para animaciones de carga -->
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        .modal {
            display: none;
        }
        
        .modal.show {
            display: block;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Mejoras visuales para el estado de carga inicial */
        .container {
            transition: opacity 0.3s ease;
        }
        
        /* Toast styles básicos para notificaciones */
        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            pointer-events: auto;
            border-left: 4px solid #28a745;
            min-width: 320px;
            max-width: 400px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.error { border-left-color: #dc3545; }
        .toast.warning { border-left-color: #ffc107; }
        .toast.info { border-left-color: #17a2b8; }
        
        .toast-close {
            background: none;
            border: none;
            font-size: 1.2em;
            color: #6c757d;
            cursor: pointer;
            margin-left: auto;
        }
    </style>
</head>

<body>
    <!-- El contenido principal ya está definido arriba -->
</body>
</html>
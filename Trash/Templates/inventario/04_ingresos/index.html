<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì¶ Ingreso Manual de Mercader√≠a - Sistema de Control de Stock</title>
    <meta name="description" content="M√≥dulo para ingreso manual de existencias al inventario">
    <meta name="author" content="Sistema de Inventario">
    
    <!-- Estilos -->
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="extra.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüì¶%3C/text%3E%3C/svg%3E">
</head>

<body>
    <!-- Contenedor Principal -->
    <div class="container">
        
        <!-- Header del M√≥dulo -->
        <div class="ingreso-header">
            <h1>üì¶ Ingreso Manual de Mercader√≠a</h1>
            <p class="subtitle">Sistema para adici√≥n manual de existencias al inventario</p>
            <div class="header-actions">
                <button class="header-btn" id="btn-view-history" title="Ver historial de ingresos">
                    üìã Historial
                </button>
                <button class="header-btn" onclick="window.print()" title="Imprimir vista actual">
                    üñ®Ô∏è Imprimir
                </button>
                <button class="header-btn" onclick="window.location.href='../'" title="Volver al dashboard">
                    üè† Dashboard
                </button>
            </div>
        </div>

        <!-- Layout Principal -->
        <div class="ingreso-container">
            
            <!-- Panel Principal -->
            <div class="main-panel">
                
                <!-- Configuraci√≥n Inicial -->
                <div class="config-section">
                    <h3>‚öôÔ∏è Configuraci√≥n del Ingreso</h3>
                    <div class="config-grid">
                        <div class="form-group">
                            <label for="warehouse-select">Bodega de Destino *</label>
                            <select id="warehouse-select" class="form-control" required>
                                <option value="">Seleccionar bodega...</option>
                                <!-- Las opciones se cargan din√°micamente -->
                            </select>
                        </div>
                        <div class="documento-info">
                            <div class="documento-numero" id="document-number">Generando...</div>
                            <div class="documento-fecha" id="document-date">--/--/---- --:--:--</div>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n Agregar Item -->
                <div class="add-item-section">
                    <h3>üîç Buscar y Agregar Producto</h3>
                    
                    <!-- B√∫squeda de Producto -->
                    <div class="search-product-row">
                        <div class="product-search-input">
                            <input type="text" id="product-search-input" class="product-search-field" 
                                   placeholder="Escriba c√≥digo del producto o SKU..." disabled>
                            <span class="search-icon">üîç</span>
                        </div>
                        <button type="button" id="btn-search-product" class="btn-search-product">
                            üîç Buscar en Cat√°logo
                        </button>
                    </div>

                    <!-- Preview del Producto Seleccionado -->
                    <div id="selected-product-preview" class="selected-product-preview">
                        <!-- El contenido se genera din√°micamente -->
                    </div>

                    <!-- Formulario de Item -->
                    <div class="item-form-grid">
                        <div class="form-group">
                            <label for="quantity-input">Cantidad *</label>
                            <input type="number" id="quantity-input" class="quantity-input" 
                                   placeholder="0" min="0.01" step="0.01" disabled>
                        </div>
                        
                        <div class="form-group">
                            <label for="motivo-select">Motivo de Ingreso *</label>
                            <select id="motivo-select" class="form-control" disabled>
                                <option value="">Seleccionar motivo...</option>
                                <!-- Las opciones se cargan din√°micamente -->
                            </select>
                        </div>
                        
                        <button type="button" id="btn-add-item" class="btn-add-item" disabled>
                            ‚ûï Agregar
                        </button>
                    </div>

                    <!-- Justificaci√≥n -->
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="justification-textarea">Justificaci√≥n / Evidencia *</label>
                        <textarea id="justification-textarea" class="form-control" rows="3" 
                                  placeholder="Describe el motivo del ingreso..." 
                                  maxlength="500" disabled></textarea>
                        <small class="text-muted">M√≠nimo 10 caracteres, m√°ximo 500 caracteres</small>
                    </div>
                </div>

                <!-- Items Pendientes -->
                <div class="items-pending-section">
                    <h3>
                        üì¶ Items Pendientes de Ingreso
                        <span class="items-counter" id="items-counter">0</span>
                    </h3>
                    
                    <div class="items-table-container">
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th style="width: 120px; text-align: center;">Cantidad</th>
                                    <th style="width: 250px;">Motivo y Justificaci√≥n</th>
                                    <th style="width: 100px; text-align: center;">Agregado</th>
                                    <th style="width: 60px; text-align: center;">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="items-table-body">
                                <tr>
                                    <td colspan="5" class="empty-items">
                                        <div class="empty-items-icon">üì¶</div>
                                        <h4>No hay items pendientes</h4>
                                        <p>Agregue productos para crear el ingreso de mercader√≠a</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

            <!-- Panel Lateral -->
            <div class="side-panel">
                
                <!-- Resumen del Ingreso -->
                <div class="summary-card">
                    <h3>üìä Resumen del Ingreso</h3>
                    
                    <div class="summary-row">
                        <span class="summary-label">Bodega:</span>
                        <span class="summary-value" id="summary-warehouse">No seleccionada</span>
                    </div>
                    
                    <div class="summary-row">
                        <span class="summary-label">Documento:</span>
                        <span class="summary-value" id="summary-document">Generando...</span>
                    </div>
                    
                    <div class="summary-row">
                        <span class="summary-label">Total Items:</span>
                        <span class="summary-value highlight" id="summary-total-items">0</span>
                    </div>
                    
                    <div class="summary-row total-row">
                        <span class="summary-label">Cantidad Total:</span>
                        <span class="summary-value" id="summary-total-quantity">0</span>
                    </div>
                </div>

                <!-- Acciones Principales -->
                <div class="actions-card">
                    <h3>üöÄ Acciones</h3>
                    
                    <div class="action-buttons">
                        <button type="button" id="btn-process-ingreso" class="btn-primary-action" disabled>
                            ‚úÖ Procesar Ingreso
                        </button>
                        
                        <button type="button" id="btn-clear-all" class="btn-warning-action">
                            üßπ Limpiar Todo
                        </button>
                        
                        <button type="button" class="btn-secondary-action" onclick="window.location.href='../'">
                            üè† Volver al Dashboard
                        </button>
                    </div>
                </div>

                <!-- Historial Reciente -->
                <div class="recent-history-card">
                    <h3>üìã Ingresos Recientes</h3>
                    <div class="history-list" id="recent-history-list">
                        <!-- El contenido se carga din√°micamente -->
                    </div>
                </div>

            </div>
        </div>

        <!-- Informaci√≥n del Sistema -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 25px; font-size: 0.9em; color: #6c757d; text-align: center;">
            <div style="margin-bottom: 10px;">
                <strong>M√≥dulo de Ingreso Manual v1.0.0</strong> - 
                Sistema de adici√≥n de existencias al inventario
            </div>
            <div>
                üì¶ Actualizaci√≥n autom√°tica de stock | 
                üìù Registro de movimientos | 
                üîí Validaciones de seguridad | 
                üìä Trazabilidad completa
            </div>
        </div>
    </div>

    <!-- Container para Toasts -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Scripts -->
    <script src="script.js"></script>
    
    <!-- Script para fecha/hora en tiempo real -->
    <script>
        function updateDateTime() {
            const now = new Date();
            const dateTimeElements = document.querySelectorAll('[data-live-time]');
            
            dateTimeElements.forEach(element => {
                const options = {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                };
                element.textContent = now.toLocaleDateString('es-CL', options);
            });
        }
        
        // Actualizar cada segundo
        setInterval(updateDateTime, 1000);
        updateDateTime();
    </script>

    <!-- PWA y configuraciones adicionales -->
    <script>
        // Detectar capacidades del navegador
        if ('serviceWorker' in navigator) {
            console.log('üîß Service Worker disponible');
        }
        
        // Prevenir zoom accidental en inputs num√©ricos
        document.addEventListener('wheel', function(e) {
            if (document.activeElement.type === 'number') {
                document.activeElement.blur();
            }
        });
        
        // Logging de uso del m√≥dulo
        console.log('üì¶ M√≥dulo de Ingreso de Mercader√≠a iniciado:', {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent.substring(0, 100),
            viewport: {
                width: window.innerWidth,
                height: window.innerHeight
            },
            connection: navigator.connection ? {
                effectiveType: navigator.connection.effectiveType,
                downlink: navigator.connection.downlink
            } : 'unknown'
        });
        
        // Prevenir p√©rdida de datos accidental
        let hasUnsavedChanges = false;
        
        window.addEventListener('beforeunload', function(e) {
            // Solo mostrar advertencia si hay items pendientes
            if (typeof IngresoApp !== 'undefined' && 
                IngresoApp.pendingItems && 
                IngresoApp.pendingItems.length > 0) {
                
                const message = 'Tiene items pendientes de procesar. ¬øEst√° seguro de salir?';
                e.returnValue = message;
                return message;
            }
        });
        
        // Atajos de teclado √∫tiles
        document.addEventListener('keydown', function(e) {
            // Ctrl + Enter para procesar ingreso
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                const processBtn = document.getElementById('btn-process-ingreso');
                if (processBtn && !processBtn.disabled) {
                    processBtn.click();
                }
            }
            
            // F2 para buscar producto
            if (e.key === 'F2') {
                e.preventDefault();
                const searchBtn = document.getElementById('btn-search-product');
                if (searchBtn) {
                    searchBtn.click();
                }
            }
            
            // Escape para limpiar b√∫squeda
            if (e.key === 'Escape') {
                const searchInput = document.getElementById('product-search-input');
                if (searchInput && document.activeElement === searchInput) {
                    searchInput.value = '';
                    searchInput.blur();
                }
            }
        });
        
        // Optimizaci√≥n para dispositivos t√°ctiles
        if ('ontouchstart' in window) {
            document.body.classList.add('touch-device');
            console.log('üì± Dispositivo t√°ctil detectado');
        }
    </script>

    <!-- Meta tags para PWA -->
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ingreso Mercader√≠a">
    
    <!-- Configuraci√≥n de viewport optimizada -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- Preload de recursos cr√≠ticos -->
    <link rel="preload" href="../style.css" as="style">
    <link rel="preload" href="extra.css" as="style">
    <link rel="preload" href="../data.json" as="fetch" crossorigin>
    <link rel="preload" href="data_extend.json" as="fetch" crossorigin>

</head>

<!-- Scripts adicionales para mejorar UX -->
<script>
    // Manejo de errores globales espec√≠fico del m√≥dulo
    window.addEventListener('error', function(e) {
        console.error('‚ùå Error en m√≥dulo de ingreso:', e.error);
        
        // Mostrar notificaci√≥n al usuario si la aplicaci√≥n est√° cargada
        if (typeof showError === 'function') {
            showError('Ha ocurrido un error inesperado. Verifique la consola para m√°s detalles.');
        }
    });
    
    // Manejo de promesas rechazadas
    window.addEventListener('unhandledrejection', function(e) {
        console.error('‚ùå Promesa rechazada en m√≥dulo de ingreso:', e.reason);
        
        if (typeof showError === 'function') {
            showError('Error de conectividad. Verifique su conexi√≥n a internet.');
        }
    });
    
    // Funci√≥n para reportar problemas (desarrollo)
    function reportIssue(description) {
        const report = {
            module: 'ingreso-mercaderia',
            timestamp: new Date().toISOString(),
            description: description,
            userAgent: navigator.userAgent,
            url: window.location.href,
            viewport: {
                width: window.innerWidth,
                height: window.innerHeight
            }
        };
        
        console.log('üìã Reporte de problema:', report);
        
        // En producci√≥n, esto se enviar√≠a a un servicio de logging
        return report;
    }
    
    // Funci√≥n de ayuda para desarrolladores
    function showHelp() {
        const helpText = `
üîß ATAJOS DE TECLADO:
‚Ä¢ F2: Abrir b√∫squeda de productos
‚Ä¢ Ctrl + Enter: Procesar ingreso (si hay items)
‚Ä¢ Escape: Limpiar b√∫squeda activa

üìù FLUJO DE TRABAJO:
1. Seleccionar bodega de destino
2. Buscar producto por c√≥digo o cat√°logo
3. Ingresar cantidad y motivo
4. Agregar a lista de pendientes
5. Procesar ingreso cuando est√© listo

üêõ DEBUG:
‚Ä¢ window.IngresoDebug: Objeto con funciones de depuraci√≥n
‚Ä¢ reportIssue('descripci√≥n'): Reportar problemas
        `;
        
        console.log(helpText);
        
        if (typeof showInfo === 'function') {
            showInfo('Ayuda mostrada en consola (F12)');
        }
    }
    
    // Exponer funci√≥n de ayuda globalmente
    window.showHelp = showHelp;
    
    console.log('üí° Tip: Escriba showHelp() en consola para ver atajos y ayuda');
</script>

</body>
</html>
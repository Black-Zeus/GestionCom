<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema POS - Caja</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="extra.css" />
</head>

<body>
    <!-- Contenedor de Toasts -->
    <div id="toast-container" class="toast-container"></div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üí∞ Sistema de Caja</h1>
            <div class="user-info">
                <strong>Cajero:</strong> <span id="cashier-name">Cargando...</span><br />
                <strong>Caja:</strong> <span id="register-name">Cargando...</span> ‚Ä¢
                <strong>Fecha:</strong> <span id="current-date"></span><br />
                <strong>Estado:</strong> <span id="session-status" class="session-active">Sesi√≥n Activa</span>
            </div>
        </div>

        <!-- Contenido Principal - MODIFICADO para una sola columna -->
        <div class="main-content">
            <!-- Panel Principal de Ventas - Ahora ocupa todo el ancho -->
            <div class="sales-form">
                <!-- B√∫squeda por Folio -->
                <div class="folio-search-section">
                    <h3>üîç Buscar Venta por Folio</h3>
                    <div class="folio-search-row">
                        <div class="form-group">
                            <label for="sale-folio">Folio de Venta</label>
                            <input type="text" id="sale-folio" class="form-control folio-input" placeholder="PV240001"
                                onkeypress="handleFolioEnter(event)" oninput="handleFolioInput(event)"
                                autocomplete="off" />
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="searchByFolio()">
                                üîç Buscar
                            </button>
                        </div>
                    </div>

                    <!-- Preview de la venta encontrada -->
                    <div id="sale-preview" class="sale-preview" style="display: none">
                        <div class="alert alert-success">
                            <div class="alert-icon">‚úì</div>
                            <div class="alert-content">
                                <div class="sale-preview-header">
                                    <strong id="preview-folio">PV240001</strong>
                                    <span id="preview-total" class="sale-preview-total">$0</span>
                                </div>
                                <div id="preview-details" class="sale-preview-details">
                                    Cliente: ‚Ä¢ Items: ‚Ä¢ Fecha:
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista de Ventas Pendientes -->
                <div class="pending-sales-section">
                    <h3>üìã Ventas Pendientes de Facturaci√≥n</h3>

                    <!-- Filtros -->
                    <div class="filters-row">
                        <div class="form-group">
                            <label for="date-filter">Fecha</label>
                            <select id="date-filter" class="form-control" onchange="filterPendingSales()">
                                <option value="today">Hoy</option>
                                <option value="yesterday">Ayer</option>
                                <option value="week">Esta semana</option>
                                <option value="all">Todas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="customer-filter">Cliente</label>
                            <input type="text" id="customer-filter" class="form-control"
                                placeholder="Filtrar por cliente..." autocomplete="off" />
                        </div>
                        <div class="form-group">
                            <label for="amount-filter">Monto</label>
                            <select id="amount-filter" class="form-control" onchange="filterPendingSales()">
                                <option value="">Todos los montos</option>
                                <option value="0-100000">Hasta $100.000</option>
                                <option value="100000-500000">$100.000 - $500.000</option>
                                <option value="500000-1000000">$500.000 - $1.000.000</option>
                                <option value="1000000+">M√°s de $1.000.000</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-secondary" onclick="refreshPendingSales()" title="Actualizar (F5)">
                                üîÑ Actualizar
                            </button>
                        </div>
                    </div>

                    <!-- Estad√≠sticas r√°pidas - EXPANDIDAS -->
                    <div class="stats-row">
                        <div class="stat-card" data-tooltip="Ventas esperando ser facturadas">
                            <div class="stat-number" id="pending-count">0</div>
                            <div class="stat-label">Ventas Pendientes</div>
                        </div>
                        <div class="stat-card" data-tooltip="Valor total de ventas pendientes">
                            <div class="stat-number" id="pending-total">$0</div>
                            <div class="stat-label">Total Pendiente</div>
                        </div>
                        <div class="stat-card" data-tooltip="Ventas procesadas el d√≠a de hoy">
                            <div class="stat-number" id="today-processed">0</div>
                            <div class="stat-label">Facturadas Hoy</div>
                        </div>
                        <div class="stat-card" data-tooltip="Promedio por venta hoy">
                            <div class="stat-number" id="average-sale">$0</div>
                            <div class="stat-label">Promedio por Venta</div>
                        </div>
                    </div>

                    <!-- Tabla de ventas pendientes - EXPANDIDA -->
                    <div class="pending-sales-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Folio</th>
                                    <th>Cliente</th>
                                    <th>Comprador</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Fecha/Hora</th>
                                    <th>Vendedor</th>
                                    <th>Estado</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="pending-sales-tbody">
                                <!-- Las ventas pendientes se cargan din√°micamente -->
                            </tbody>
                        </table>
                        <div id="empty-pending" class="empty-table">
                            <div class="empty-table-icon">üìÑ</div>
                            <div>No hay ventas pendientes</div>
                            <small>Todas las ventas han sido procesadas</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Detalle de Venta - NUEVO -->
        <div id="saleDetailModal" class="modal sale-detail-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìÑ Detalle de Venta</h2>
                    <span class="close" onclick="closeSaleDetailModal()">&times;</span>
                </div>

                <div class="modal-body">
                    <div class="info-content">
                        <!-- Resumen principal -->
                        <div class="sale-detail-summary">
                            <div class="sale-detail-header">
                                <div class="sale-detail-folio">
                                    üìã <span id="modal-sale-folio">PV240001</span>
                                </div>
                                <div class="sale-detail-total" id="modal-sale-total">$0</div>
                            </div>
                            <div class="sale-detail-customer" id="modal-sale-customer">Cliente</div>
                            <div class="sale-detail-info" id="modal-sale-info">
                                <span>üìÖ Fecha</span>
                                <span>üë§ Vendedor</span>
                                <span>üì¶ Items</span>
                            </div>
                        </div>

                        <!-- Secciones de informaci√≥n -->
                        <div class="sale-detail-sections">
                            <!-- Informaci√≥n del cliente -->
                            <div class="detail-section">
                                <h4>üë§ Informaci√≥n del Cliente</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <strong>RUT</strong>
                                        <span id="modal-customer-rut">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <strong>Nombre</strong>
                                        <span id="modal-customer-name">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <strong>Tipo</strong>
                                        <span id="modal-customer-type">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <strong>Email</strong>
                                        <span id="modal-customer-email">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <strong>Tel√©fono</strong>
                                        <span id="modal-customer-phone">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <strong>Cr√©dito</strong>
                                        <span id="modal-customer-credit">-</span>
                                    </div>
                                </div>

                                <!-- Comprador autorizado (si aplica) -->
                                <div id="modal-buyer-section" class="buyer-info" style="display: none">
                                    <div class="buyer-highlight">
                                        <strong>Comprador Autorizado:</strong>
                                        <div style="margin-top: 8px;">
                                            <strong>Nombre:</strong> <span id="modal-buyer-name">-</span><br>
                                            <strong>Cargo:</strong> <span id="modal-buyer-position">-</span><br>
                                            <strong>Email:</strong> <span id="modal-buyer-email">-</span><br>
                                            <strong>Nivel:</strong> <span id="modal-buyer-auth">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Informaci√≥n de la venta -->
                            <div class="detail-section">
                                <h4>‚ÑπÔ∏è Informaci√≥n de la Venta</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <strong>Fecha</strong>
                                        <span id="modal-sale-date">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <strong>Hora</strong>
                                        <span id="modal-sale-time">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <strong>Vendedor</strong>
                                        <span id="modal-sale-seller">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <strong>Sucursal</strong>
                                        <span id="modal-sale-warehouse">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <strong>Terminal</strong>
                                        <span id="modal-sale-terminal">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <strong>Estado</strong>
                                        <span id="modal-sale-status">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <strong>Tipo Venta</strong>
                                        <span id="modal-credit-type">-</span>
                                    </div>
                                    <div class="detail-item" style="display: none">
                                        <strong>T√©rminos Cr√©dito</strong>
                                        <span id="modal-credit-terms">-</span>
                                    </div>
                                    <div class="detail-item" style="display: none">
                                        <strong>Notas</strong>
                                        <span id="modal-sale-notes">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Items de la venta -->
                            <div class="detail-section detail-items-section">
                                <h4>üì¶ Productos</h4>
                                <div class="detail-items-table">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>C√≥digo</th>
                                                <th>Producto</th>
                                                <th>Cant.</th>
                                                <th>Precio Unit.</th>
                                                <th>Desc.</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="modal-items-tbody">
                                            <!-- Items se cargan din√°micamente -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Totales -->
                        <div class="totals-summary">
                            <div class="total-row">
                                <span>Total de Items:</span>
                                <span id="modal-total-items">0</span>
                            </div>
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span id="modal-subtotal">$0</span>
                            </div>
                            <div class="total-row">
                                <span>Descuentos por L√≠nea:</span>
                                <span id="modal-line-discounts">$0</span>
                            </div>
                            <div class="total-row">
                                <span>Descuento del Documento:</span>
                                <span id="modal-document-discount">$0</span>
                            </div>
                            <div class="total-row">
                                <span>IVA (19%):</span>
                                <span id="modal-tax">$0</span>
                            </div>
                            <div class="total-row total-final">
                                <span>TOTAL:</span>
                                <span id="modal-total">$0</span>
                            </div>
                        </div>
                    </div>
                    <!-- Acciones del modal -->
                    <div class="detail-modal-actions">
                        <div class="btn-group-left">
                            <button class="btn btn-info" onclick="printSaleDetail()" title="Imprimir Detalle">
                                üñ®Ô∏è Imprimir
                            </button>
                            <button class="btn btn-secondary" onclick="closeSaleDetailModal()" title="Cerrar">
                                ‚ùå Cerrar
                            </button>
                        </div>
                        <div class="btn-group-right">
                            <button class="btn btn-success btn-lg" onclick="processSaleFromModal()"
                                title="Procesar Pago (Ctrl+P)">
                                üí∞ Procesar Pago
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Procesamiento de Pago -->
        <div id="paymentModal" class="modal payment-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üí≥ Procesar Pago</h2>
                    <span class="close" onclick="closePaymentModal()">&times;</span>
                </div>

                <div class="modal-body">
                    <!-- Resumen de la venta -->
                    <div class="payment-summary">
                        <div class="payment-summary-header">
                            <div class="payment-folio" id="payment-folio">PV240001</div>
                            <div class="payment-total" id="payment-total">$0</div>
                        </div>
                        <div class="payment-customer" id="payment-customer">Cliente</div>
                    </div>

                    <!-- M√©todos de pago -->
                    <div class="payment-methods-section">
                        <h4>üí≥ M√©todo de Pago</h4>
                        <div class="payment-methods-grid">
                            <div class="payment-method-card" onclick="selectPaymentMethod('CASH')"
                                data-tooltip="Pago en efectivo con vuelto">
                                <div class="payment-method-icon">üíµ</div>
                                <div class="payment-method-name">Efectivo</div>
                            </div>
                            <div class="payment-method-card" onclick="selectPaymentMethod('DEBIT')"
                                data-tooltip="Tarjeta de d√©bito">
                                <div class="payment-method-icon">üí≥</div>
                                <div class="payment-method-name">D√©bito</div>
                            </div>
                            <div class="payment-method-card" onclick="selectPaymentMethod('CREDIT')"
                                data-tooltip="Tarjeta de cr√©dito">
                                <div class="payment-method-icon">üí≥</div>
                                <div class="payment-method-name">Cr√©dito</div>
                            </div>
                            <div class="payment-method-card" onclick="selectPaymentMethod('TRANSFER')"
                                data-tooltip="Transferencia bancaria">
                                <div class="payment-method-icon">üè¶</div>
                                <div class="payment-method-name">Transferencia</div>
                            </div>
                            <div class="payment-method-card" onclick="selectPaymentMethod('CREDIT_ACCOUNT')"
                                data-tooltip="Cuenta corriente del cliente">
                                <div class="payment-method-icon">üìã</div>
                                <div class="payment-method-name">Cuenta Corriente</div>
                            </div>
                        </div>
                    </div>

                    <!-- Detalles de pago espec√≠ficos -->
                    <div id="payment-details" class="payment-details" style="display: none">
                        <!-- Para efectivo -->
                        <div id="cash-details" class="payment-detail-section" style="display: none">
                            <h4>üíµ Pago en Efectivo</h4>
                            <div class="cash-payment-grid">
                                <div class="form-group">
                                    <label for="amount-received">Monto Recibido</label>
                                    <input type="number" id="amount-received" class="form-control amount-input"
                                        placeholder="0" min="0" step="1" />
                                </div>
                                <div class="form-group">
                                    <label>Vuelto</label>
                                    <div class="change-display" id="change-amount">$0</div>
                                </div>
                            </div>
                        </div>

                        <!-- Para tarjetas -->
                        <div id="card-details" class="payment-detail-section" style="display: none">
                            <h4>üí≥ Pago con Tarjeta</h4>
                            <div class="card-payment-grid">
                                <div class="form-group">
                                    <label for="card-number">√öltimos 4 d√≠gitos</label>
                                    <input type="text" id="card-number" class="form-control" placeholder="1234"
                                        maxlength="4" />
                                </div>
                                <div class="form-group">
                                    <label for="authorization-code">C√≥digo de Autorizaci√≥n</label>
                                    <input type="text" id="authorization-code" class="form-control" placeholder="ABC123"
                                        maxlength="10" />
                                </div>
                            </div>
                        </div>

                        <!-- Para transferencia -->
                        <div id="transfer-details" class="payment-detail-section" style="display: none">
                            <h4>üè¶ Transferencia Bancaria</h4>
                            <div class="transfer-payment-grid">
                                <div class="form-group">
                                    <label for="bank-name">Banco</label>
                                    <input type="text" id="bank-name" class="form-control"
                                        placeholder="Banco de Chile" />
                                </div>
                                <div class="form-group">
                                    <label for="transfer-reference">N√∫mero de Referencia</label>
                                    <input type="text" id="transfer-reference" class="form-control"
                                        placeholder="TRF123456789" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Acciones del modal -->
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="closePaymentModal()">
                            Cancelar
                        </button>
                        <button class="btn btn-success" id="confirm-payment-btn" onclick="confirmPayment()" disabled>
                            ‚úì Confirmar Pago
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Confirmaci√≥n de Facturaci√≥n -->
        <div id="invoiceModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìÑ Generar Factura</h2>
                    <span class="close" onclick="closeInvoiceModal()">&times;</span>
                </div>

                <div class="modal-body">
                    <div class="invoice-confirmation">
                        <div class="alert alert-success">
                            <div class="alert-icon">‚úì</div>
                            <div class="alert-content">
                                <strong>Pago procesado exitosamente</strong><br>
                                La venta ha sido registrada y est√° lista para facturar
                            </div>
                        </div>

                        <div class="invoice-summary">
                            <div class="invoice-detail">
                                <strong>Folio de Venta:</strong> <span id="invoice-folio">-</span>
                            </div>
                            <div class="invoice-detail">
                                <strong>Cliente:</strong> <span id="invoice-customer">-</span>
                            </div>
                            <div class="invoice-detail">
                                <strong>Total:</strong> <span id="invoice-total">-</span>
                            </div>
                            <div class="invoice-detail">
                                <strong>M√©todo de Pago:</strong> <span id="invoice-payment-method">-</span>
                            </div>
                            <div class="invoice-detail">
                                <strong>Fecha:</strong> <span id="invoice-date">-</span>
                            </div>
                        </div>

                        <div class="document-type-selection">
                            <h4>üìã Tipo de Documento</h4>
                            <div class="document-type-grid">
                                <div class="document-type-card active" onclick="selectDocumentType('BOLETA')">
                                    <div class="document-type-icon">üßæ</div>
                                    <div class="document-type-name">Boleta</div>
                                    <div class="document-type-desc">Para consumidor final</div>
                                </div>
                                <div class="document-type-card" onclick="selectDocumentType('FACTURA')">
                                    <div class="document-type-icon">üìÑ</div>
                                    <div class="document-type-name">Factura</div>
                                    <div class="document-type-desc">Para empresas</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="closeInvoiceModal()">
                            Cerrar
                        </button>
                        <button class="btn btn-success" onclick="generateInvoice()">
                            üìÑ Generar Documento
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="script.js"></script>
    <script>
        // Actualizar fecha y hora inicial
        document.addEventListener("DOMContentLoaded", function () {
            const now = new Date();
            const dateStr = now.toLocaleDateString("es-CL");
            const timeStr = now.toLocaleTimeString("es-CL", {
                hour: "2-digit",
                minute: "2-digit",
            });

            const currentDateEl = document.getElementById("current-date");
            if (currentDateEl) {
                currentDateEl.textContent = dateStr;
            }

            // Mostrar informaci√≥n de atajos al cargar
            console.log(`
üîß ATAJOS DE TECLADO DISPONIBLES:
‚Ä¢ Ctrl + F: Enfocar b√∫squeda de folio
‚Ä¢ Ctrl + R: Actualizar lista de ventas
‚Ä¢ Ctrl + P: Procesar pago (si hay venta seleccionada)
‚Ä¢ F5: Actualizar lista de ventas
‚Ä¢ Escape: Cerrar modales
‚Ä¢ Flechas: Navegar en tabla de ventas
‚Ä¢ Enter/Espacio: Abrir detalle de venta
‚Ä¢ Click en fila: Abrir modal de detalle
        `);
        });
    </script>
</body>

</html>
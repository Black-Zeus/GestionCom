<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ Ajustes de Inventario - Sistema de Control de Stock</title>
    <meta name="description" content="MÃ³dulo de ajustes de inventario con workflow de aprobaciÃ³n y conteos cÃ­clicos">
    <meta name="author" content="Sistema de Inventario">
    
    <!-- Estilos -->
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="extra.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸ”§%3C/text%3E%3C/svg%3E">
</head>

<body>
    <!-- Contenedor Principal -->
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ”§ Ajustes de Inventario</h1>
            <div class="user-info">
                <div><strong>Usuario:</strong> Juan PÃ©rez - Jefe de Bodega</div>
                <div id="current-date-time"></div>
            </div>
        </div>

        <!-- MÃ©tricas Principales -->
        <div class="adjustments-dashboard" id="adjustments-metrics">
            <!-- Las mÃ©tricas se cargan dinÃ¡micamente -->
        </div>

        <!-- Controles y Filtros -->
        <div class="adjustments-controls">
            <div class="controls-header">
                <h3 class="controls-title">ğŸ” Filtros y Controles</h3>
                <div class="quick-actions-adjustments">
                    <button class="btn btn-primary" onclick="showCreateAdjustmentModal()">
                        â• Nuevo Ajuste
                    </button>
                    <button class="btn btn-info" onclick="showCreateCycleCountModal()">
                        ğŸ“… Programar Conteo
                    </button>
                    <button class="btn btn-secondary" onclick="exportAdjustmentsReport()">
                        ğŸ“Š Exportar
                    </button>
                </div>
            </div>

            <div class="filters-grid">
                <div class="form-group">
                    <label>ğŸ” Buscar:</label>
                    <input type="text" id="adjustment-search" class="form-control" 
                           placeholder="NÃºmero, descripciÃ³n...">
                </div>

                <div class="form-group">
                    <label>ğŸª Bodega:</label>
                    <select id="warehouse-filter" class="form-control">
                        <option value="all">Todas las bodegas</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ğŸ“‹ Causal:</label>
                    <select id="reason-filter" class="form-control">
                        <option value="all">Todas las causales</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ğŸ“… Desde:</label>
                    <input type="date" id="date-from-filter" class="form-control">
                </div>

                <div class="form-group">
                    <label>ğŸ“… Hasta:</label>
                    <input type="date" id="date-to-filter" class="form-control">
                </div>
            </div>

            <div class="status-filter-buttons">
                <button class="status-filter-btn active" data-status="all">ğŸ“‹ Todos</button>
                <button class="status-filter-btn pending" data-status="pending">â³ Pendientes</button>
                <button class="status-filter-btn approved" data-status="approved">âœ… Aprobados</button>
                <button class="status-filter-btn rejected" data-status="rejected">âŒ Rechazados</button>
                <button class="status-filter-btn" data-status="applied">ğŸ”„ Aplicados</button>
            </div>
        </div>

        <!-- Tabla de Ajustes -->
        <div class="adjustments-table-container">
            <table class="adjustments-table">
                <thead>
                    <tr>
                        <th>ğŸ“„ NÃºmero</th>
                        <th>ğŸ“‹ Causal</th>
                        <th>ğŸ·ï¸ Estado</th>
                        <th>ğŸª Bodega</th>
                        <th>ğŸ“¦ Items</th>
                        <th>ğŸ“… Fecha</th>
                        <th>ğŸ‘¤ Creado Por</th>
                        <th>ğŸ“ Evidencia</th>
                        <th>âš™ï¸ Acciones</th>
                    </tr>
                </thead>
                <tbody id="adjustments-table-body">
                    <!-- Las filas se cargan dinÃ¡micamente -->
                </tbody>
            </table>
        </div>

        <!-- Layout de Conteos y Reportes -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 25px;">
            <!-- Conteos CÃ­clicos -->
            <div class="cycle-counts-section" id="cycle-counts-container">
                <!-- Los conteos se cargan dinÃ¡micamente -->
            </div>

            <!-- Reportes y EstadÃ­sticas -->
            <div class="reports-section" id="reports-container">
                <!-- Los reportes se cargan dinÃ¡micamente -->
            </div>
        </div>

        <!-- InformaciÃ³n del Sistema -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 25px; font-size: 0.9em; color: #6c757d; text-align: center;">
            <div style="margin-bottom: 10px;">
                <strong>MÃ³dulo de Ajustes de Inventario v1.0.0</strong> - 
                Sistema completo de ajustes con workflow de aprobaciÃ³n y conteos cÃ­clicos
            </div>
            <div>
                ğŸ”§ GestiÃ³n de causales y evidencias | 
                ğŸ“Š Conteos automÃ¡ticos | 
                âš¡ Workflow de aprobaciÃ³n integrado
            </div>
        </div>
    </div>

    <!-- ============================================================================ -->
    <!-- MODALES -->
    <!-- ============================================================================ -->

    <!-- Modal Crear/Editar Ajuste -->
    <div id="adjustment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="adjustment-modal-title">â• Crear Nuevo Ajuste</h2>
                <button class="close" onclick="closeModal('adjustment-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="adjustment-form" class="adjustment-form">
                    <!-- InformaciÃ³n General -->
                    <div class="form-section">
                        <h4 class="section-title">
                            ğŸ“‹ InformaciÃ³n General
                        </h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>ğŸª Bodega:</label>
                                <select id="adjustment-warehouse" class="form-control" required>
                                    <!-- Las opciones se cargan dinÃ¡micamente -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ğŸ“… Fecha del Ajuste:</label>
                                <input type="date" id="adjustment-date" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ğŸ“ DescripciÃ³n:</label>
                            <textarea id="adjustment-description" class="form-control" rows="3" 
                                      placeholder="Describe el motivo del ajuste..."></textarea>
                        </div>
                    </div>

                    <!-- SelecciÃ³n de Causal -->
                    <div class="form-section">
                        <h4 class="section-title">
                            ğŸ“‹ Causal del Ajuste
                        </h4>
                        <div id="reason-selector" class="reason-selector">
                            <!-- Las causales se cargan dinÃ¡micamente -->
                        </div>
                    </div>

                    <!-- Evidencia -->
                    <div class="form-section" id="evidence-section" style="display: none;">
                        <h4 class="section-title">
                            ğŸ“ Evidencia Requerida
                        </h4>
                        <div id="evidence-upload-zone" class="evidence-upload">
                            <div class="upload-icon">ğŸ“¤</div>
                            <div class="upload-text">Arrastra archivos aquÃ­ o haz clic para seleccionar</div>
                            <div class="upload-hint">Formatos: JPG, PNG, PDF (mÃ¡x. 10MB cada uno)</div>
                        </div>
                        <div id="uploaded-files-list" class="uploaded-files">
                            <!-- Los archivos se muestran aquÃ­ -->
                        </div>
                    </div>

                    <!-- Productos a Ajustar -->
                    <div class="products-to-adjust">
                        <h4 class="section-title">
                            ğŸ“¦ Productos a Ajustar
                        </h4>
                        
                        <div class="product-search-section">
                            <div class="product-search-row">
                                <div class="product-search-input">
                                    <input type="text" id="product-search-input" class="form-control" 
                                           placeholder="Buscar producto por nombre, SKU o cÃ³digo...">
                                    <div id="search-results-dropdown" class="search-results-dropdown" style="display: none;">
                                        <!-- Los resultados se muestran aquÃ­ -->
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>ğŸ“Š Vista:</label>
                                    <select class="form-control">
                                        <option>Todos</option>
                                        <option>Con Stock</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-secondary">
                                    ğŸ” Buscar
                                </button>
                            </div>
                        </div>

                        <table class="products-table">
                            <thead>
                                <tr>
                                    <th>ğŸ“¦ Producto</th>
                                    <th>ğŸ“Š Stock Sistema</th>
                                    <th>ğŸ”¢ Cantidad FÃ­sica</th>
                                    <th>ğŸ“ˆ Diferencia</th>
                                    <th>ğŸ“ UbicaciÃ³n</th>
                                    <th>ğŸ“ Detalle</th>
                                    <th>âŒ Quitar</th>
                                </tr>
                            </thead>
                            <tbody id="products-table-body">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">ğŸ“¦</div>
                                            <p>Busca y selecciona productos para ajustar</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Acciones del Modal -->
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('adjustment-modal')">
                            âŒ Cancelar
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveAdjustment()">
                            ğŸ’¾ Guardar Ajuste
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Detalle de Ajuste -->
    <div id="adjustment-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ” Detalle de Ajuste</h2>
                <button class="close" onclick="closeModal('adjustment-detail-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="adjustment-detail-content">
                    <!-- El contenido se carga dinÃ¡micamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Conteo CÃ­clico -->
    <div id="cycle-count-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“… Programar Conteo CÃ­clico</h2>
                <button class="close" onclick="closeModal('cycle-count-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="cycle-count-form">
                    <div class="count-form-section">
                        <h4>ğŸ“‹ InformaciÃ³n del Conteo</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>ğŸ“ Nombre del Conteo:</label>
                                <input type="text" id="count-name" class="form-control" 
                                       placeholder="Ej: Conteo Semanal Zona A" required>
                            </div>
                            <div class="form-group">
                                <label>ğŸª Bodega:</label>
                                <select id="count-warehouse" class="form-control" required>
                                    <!-- Las opciones se cargan dinÃ¡micamente -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>ğŸ“… Fecha Programada:</label>
                                <input type="date" id="count-scheduled-date" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>ğŸ‘¤ Asignar a:</label>
                                <select id="count-assigned-user" class="form-control" required>
                                    <!-- Los usuarios se cargan dinÃ¡micamente -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="count-form-section">
                        <h4>ğŸ“Š Tipo de Conteo</h4>
                        <div class="count-type-selector">
                            <div class="count-type-option" data-type="FULL" onclick="selectCountType('FULL')">
                                <span class="count-type-icon">ğŸ¢</span>
                                <div class="count-type-name">Completo</div>
                                <div class="count-type-desc">Toda la bodega</div>
                            </div>
                            <div class="count-type-option" data-type="ZONE" onclick="selectCountType('ZONE')">
                                <span class="count-type-icon">ğŸ“</span>
                                <div class="count-type-name">Por Zona</div>
                                <div class="count-type-desc">Zona especÃ­fica</div>
                            </div>
                            <div class="count-type-option" data-type="SPECIFIC" onclick="selectCountType('SPECIFIC')">
                                <span class="count-type-icon">ğŸ¯</span>
                                <div class="count-type-name">EspecÃ­fico</div>
                                <div class="count-type-desc">Productos seleccionados</div>
                            </div>
                            <div class="count-type-option" data-type="RANDOM" onclick="selectCountType('RANDOM')">
                                <span class="count-type-icon">ğŸ²</span>
                                <div class="count-type-name">Aleatorio</div>
                                <div class="count-type-desc">Muestra aleatoria</div>
                            </div>
                        </div>
                    </div>

                    <div class="count-form-section" id="zone-selection" style="display: none;">
                        <h4>ğŸ“ SelecciÃ³n de Zona</h4>
                        <div class="form-group">
                            <label>Zona a Contar:</label>
                            <select id="count-zone" class="form-control">
                                <option value="">Seleccionar zona...</option>
                            </select>
                        </div>
                    </div>

                    <div class="count-form-section">
                        <h4>ğŸ“ Notas Adicionales</h4>
                        <div class="form-group">
                            <textarea id="count-notes" class="form-control" rows="3" 
                                      placeholder="Instrucciones especiales para el conteo..."></textarea>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('cycle-count-modal')">
                            âŒ Cancelar
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveCycleCount()">
                            ğŸ“… Programar Conteo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Detalle de Conteo CÃ­clico -->
    <div id="cycle-count-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“Š Detalle de Conteo CÃ­clico</h2>
                <button class="close" onclick="closeModal('cycle-count-detail-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="cycle-count-detail-content">
                    <!-- El contenido se carga dinÃ¡micamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Container para Toasts -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Scripts -->
    <script src="script.js"></script>
    <script src="extra.js"></script>
    
    <!-- Script para mostrar fecha/hora actual -->
    <script>
        function updateDateTime() {
            const now = new Date();
            const dateTimeElement = document.getElementById('current-date-time');
            if (dateTimeElement) {
                const options = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                };
                dateTimeElement.textContent = now.toLocaleDateString('es-CL', options);
            }
        }
        
        // Actualizar fecha/hora cada segundo
        setInterval(updateDateTime, 1000);
        updateDateTime(); // Ejecutar inmediatamente
    </script>

    <!-- Configuraciones adicionales -->
    <script>
        // Logging para anÃ¡lisis de uso
        console.log('ğŸ”§ MÃ³dulo de Ajustes de Inventario iniciado:', {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            viewport: {
                width: window.innerWidth,
                height: window.innerHeight
            }
        });

        // Configurar teclas de acceso rÃ¡pido especÃ­ficas del mÃ³dulo
        document.addEventListener('keydown', (e) => {
            // Ctrl + N para nuevo ajuste
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                showCreateAdjustmentModal();
            }

            // Ctrl + E para exportar
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportAdjustmentsReport();
            }

            // Ctrl + K para focus en bÃºsqueda
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                const searchInput = document.getElementById('adjustment-search');
                if (searchInput) {
                    searchInput.focus();
                    searchInput.select();
                }
            }
        });

        // Prevenir pÃ©rdida de datos en formularios
        let formChanged = false;
        
        document.addEventListener('input', (e) => {
            if (e.target.closest('#adjustment-form, #cycle-count-form')) {
                formChanged = true;
            }
        });

        window.addEventListener('beforeunload', (e) => {
            if (formChanged) {
                e.preventDefault();
                e.returnValue = 'Â¿EstÃ¡s seguro de salir? Los cambios no guardados se perderÃ¡n.';
            }
        });

        // Resetear flag cuando se guardan los formularios
        function resetFormChangedFlag() {
            formChanged = false;
        }

        // Helper para debug en desarrollo
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            window.AdjustmentsDebug = {
                showAllModals: () => {
                    document.querySelectorAll('.modal').forEach(modal => modal.classList.add('show'));
                },
                hideAllModals: () => {
                    document.querySelectorAll('.modal').forEach(modal => modal.classList.remove('show'));
                },
                getAppState: () => AdjustmentsApp,
                simulateData: () => console.log('Datos simulados cargados')
            };
            console.log('ğŸ› ï¸ Modo desarrollo activado. Usa AdjustmentsDebug para testing.');
        }
    </script>

    <!-- Meta tags especÃ­ficos del mÃ³dulo -->
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ajustes Inventario">

</body>
</html>
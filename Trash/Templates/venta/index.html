<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Preparaci√≥n de Venta - Sistema POS Mejorado</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Contenedor de Toasts -->
    <div id="toast-container" class="toast-container"></div>

    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>üìù Preparaci√≥n de Venta</h1>
        <div class="user-info">
          <strong>Vendedor:</strong> Cargando...<br />
          <strong>Sucursal:</strong> Cargando... ‚Ä¢ <strong>Fecha:</strong>
          <span id="current-date"></span>
        </div>
      </div>

      <div class="main-content">
        <!-- Formulario Principal -->
        <div class="sales-form">
          <!-- Secci√≥n Cliente -->
          <div class="customer-section">
            <h3>üë§ Cliente</h3>
            <div class="customer-row">
              <div class="form-group">
                <label for="customer-rut">RUT Cliente</label>
                <input
                  type="text"
                  id="customer-rut"
                  class="form-control"
                  placeholder="12345678-9"
                  onblur="searchByRut()"
                  onkeypress="handleRutEnter(event)"
                />
              </div>
              <div class="form-group">
                <label for="customer-name">Raz√≥n Social/Nombre</label>
                <input
                  type="text"
                  id="customer-name"
                  class="form-control"
                  placeholder="Nombre del cliente"
                  readonly
                />
              </div>
              <div class="form-group">
                <button
                  class="btn btn-secondary"
                  onclick="openCustomerSearch()"
                >
                  üîç Buscar
                </button>
              </div>
            </div>

            <!-- Detalles del Cliente -->
            <div
              id="customer-details"
              class="customer-details"
              style="display: none"
            >
              <div class="customer-info-grid">
                <div class="customer-info-item">
                  <strong>C√≥digo:</strong> <span id="customer-code">-</span>
                </div>
                <div class="customer-info-item">
                  <strong>Tipo:</strong> <span id="customer-type">-</span>
                </div>
                <div class="customer-info-item">
                  <strong>Nombre Comercial:</strong>
                  <span id="commercial-name">-</span>
                </div>
                <div class="customer-info-item">
                  <strong>Contacto:</strong> <span id="contact-person">-</span>
                </div>
                <div class="customer-info-item">
                  <strong>Email:</strong> <span id="customer-email">-</span>
                </div>
                <div class="customer-info-item">
                  <strong>Cliente Cr√©dito:</strong>
                  <span id="customer-credit">No</span>
                </div>
              </div>

              <!-- Selector de Persona Autorizada -->
              <div
                id="authorized-buyer-section"
                class="authorized-buyer-section"
                style="display: none"
              >
                <div class="authorized-buyer-header">
                  <label>Persona que realiza la compra:</label>
                  <button
                    class="btn btn-primary btn-sm"
                    onclick="openAuthorizedBuyerModal()"
                  >
                    Seleccionar Persona
                  </button>
                </div>
                <div id="selected-buyer" class="selected-buyer no-selection">
                  <div class="buyer-name" id="buyer-name">
                    Ninguna persona seleccionada
                  </div>
                  <div class="buyer-details" id="buyer-details">
                    Seleccione una persona autorizada para continuar
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Ingreso de Productos Mejorado -->
          <div class="product-entry">
            <h3>üîç Agregar Producto</h3>
            <div class="product-input-enhanced">
              <div class="form-group">
                <label for="product-code"
                  >C√≥digo o Descripci√≥n del Producto</label
                >
                <div class="product-code-group">
                  <input
                    type="text"
                    id="product-code"
                    class="product-code-input"
                    placeholder="C√≥digo de barras, SKU o buscar por nombre..."
                    onkeypress="handleProductEnter(event)"
                    oninput="handleProductInput(event)"
                  />
                  <span class="search-icon">üîç</span>
                </div>
              </div>
              <div class="form-group">
                <div class="quick-actions">
                  <button
                    class="btn btn-info btn-sm"
                    onclick="openProductSearch()"
                    title="B√∫squeda avanzada"
                  >
                    üìã Buscar
                  </button>
                </div>
              </div>
            </div>

            <!-- Preview del Producto -->
            <div
              id="product-preview"
              class="product-preview"
              style="display: none"
            >
              <div class="alert alert-success">
                <div class="alert-icon">‚úì</div>
                <div class="alert-content">
                  <strong id="preview-name"></strong><br />
                  <span id="preview-details"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Tabla de Items Mejorada -->
          <div class="items-table">
            <table>
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Producto</th>
                  <th>Precio Unit.</th>
                  <th>Cant.</th>
                  <th>Desc. %</th>
                  <th>Subtotal</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="items-tbody">
                <!-- Items se agregan din√°micamente -->
              </tbody>
            </table>
            <div id="empty-table" class="empty-table">
              <div class="empty-table-icon">üì¶</div>
              <div>No hay productos agregados</div>
              <small
                >Ingrese un c√≥digo de producto o use la b√∫squeda para
                comenzar</small
              >
            </div>
          </div>

          <!-- Acciones del Formulario -->
          <div class="form-actions">
            <button class="btn btn-warning" onclick="clearAll()">
              üóëÔ∏è Limpiar Todo
            </button>
            <button class="btn btn-secondary" onclick="saveDraft()">
              üíæ Guardar Borrador
            </button>
          </div>
        </div>

        <!-- Panel de Resumen -->
        <div class="summary-panel">
          <h3>üìä Resumen</h3>

          <div class="summary-row">
            <span>Items:</span>
            <span id="total-items">0</span>
          </div>

          <div class="summary-row">
            <span>Subtotal:</span>
            <span id="subtotal">$0</span>
          </div>

          <div class="summary-row">
            <span>Descuentos l√≠nea:</span>
            <span id="line-discount">$0</span>
          </div>

          <div class="summary-row">
            <span>Descuento documento:</span>
            <div class="summary-row-complex">
              <input
                type="number"
                id="doc-discount"
                class="form-control"
                value="0"
                min="0"
                max="100"
                step="0.01"
                onchange="calculateTotals()"
              />
              <span>%</span>
              <span id="doc-discount-amount">$0</span>
            </div>
          </div>

          <div class="summary-row">
            <span>IVA (19%):</span>
            <span id="tax">$0</span>
          </div>

          <div class="summary-row total-row">
            <span>TOTAL:</span>
            <span id="total">$0</span>
          </div>

          <div class="actions">
            <button
              class="btn btn-success"
              onclick="sendToCashier()"
              id="send-btn"
              disabled
            >
              üì§ Enviar a Caja
            </button>
          </div>

          <div class="document-info">
            <div>
              <strong>Items:</strong>
              <span id="doc-items">0</span> productos
            </div>
            <div>
              <strong>Cliente:</strong>
              <span id="doc-customer">No seleccionado</span>
            </div>
            <div>
              <strong>Comprador:</strong>
              <span id="doc-buyer">No aplica</span>
            </div>
            <div>
              <strong>Preparado por:</strong>
              <span id="doc-prepared-by">Usuario</span>
            </div>
            <div>
              <strong>Fecha:</strong>
              <span id="doc-date"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal de B√∫squeda de Productos Mejorado -->
      <div id="productSearchModal" class="modal search-results-modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>üîç Buscar Productos</h2>
            <span class="close" onclick="closeProductSearch()">&times;</span>
          </div>

          <div class="modal-body">
            <div class="search-form-enhanced">
              <div class="search-form-grid">
                <div class="form-group">
                  <label for="product-search-term">
                    Buscar por C√≥digo, Nombre o Marca
                  </label>
                  <input
                    type="text"
                    id="product-search-term"
                    class="form-control"
                    placeholder="Ingrese t√©rmino de b√∫squeda"
                    onkeypress="handleProductSearchEnter(event)"
                  />
                </div>
                <div class="form-group">
                  <label for="product-category-filter">Categor√≠a</label>
                  <select id="product-category-filter" class="form-control">
                    <option value="">Todas las categor√≠as</option>
                  </select>
                </div>
                <div class="form-group">
                  <button class="btn btn-primary" onclick="searchProducts()">
                    Buscar
                  </button>
                </div>
              </div>
            </div>

            <div id="search-stats" class="search-stats" style="display: none">
              <span id="results-count">0 productos encontrados</span>
              <span id="search-time"></span>
            </div>

            <div id="products-grid" class="products-grid">
              <!-- Resultados de b√∫squeda se cargan din√°micamente -->
            </div>

            <div id="no-results" class="empty-table" style="display: none">
              <div class="empty-table-icon">üîç</div>
              <div>No se encontraron productos</div>
              <small>Intente con otros t√©rminos de b√∫squeda</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal de Cantidad/Confirmaci√≥n -->
      <div id="quantityModal" class="modal quantity-modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>üì¶ Agregar Producto</h2>
            <span class="close" onclick="closeQuantityModal()">&times;</span>
          </div>

          <div class="modal-body">
            <div class="product-summary">
              <div class="product-summary-title" id="quantity-product-name">
                Nombre del Producto
              </div>
              <div
                class="product-summary-details"
                id="quantity-product-details"
              >
                SKU: XXX ‚Ä¢ Marca: XXX ‚Ä¢ Stock: XXX
              </div>
              <div class="product-summary-price" id="quantity-product-price">
                $0
              </div>
            </div>

            <div class="quantity-controls">
              <button
                class="quantity-btn"
                id="quantity-decrease"
                onclick="decreaseQuantity()"
              >
                ‚àí
              </button>
              <div class="quantity-display" id="quantity-display">1</div>
              <button
                class="quantity-btn"
                id="quantity-increase"
                onclick="increaseQuantity()"
              >
                +
              </button>
            </div>

            <div class="modal-actions">
              <button class="btn btn-secondary" onclick="closeQuantityModal()">
                Cancelar
              </button>
              <button
                class="btn btn-success"
                id="confirm-add-to-cart"
                onclick="confirmAddToCart()"
              >
                ‚úì Agregar al Carrito
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal de B√∫squeda de Clientes -->
      <div id="customerModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>üîç Buscar Cliente</h2>
            <span class="close" onclick="closeCustomerSearch()">&times;</span>
          </div>

          <div class="modal-body">
            <div class="search-form-enhanced">
              <div class="search-form-grid">
                <div class="form-group">
                  <label for="search-term">
                    Buscar por RUT, Nombre o Email
                  </label>
                  <input
                    type="text"
                    id="search-term"
                    class="form-control"
                    placeholder="Ingrese t√©rmino de b√∫squeda"
                    onkeypress="handleSearchEnter(event)"
                  />
                </div>
                <div class="form-group">
                  <label for="customer-type-filter">Tipo</label>
                  <select id="customer-type-filter" class="form-control">
                    <option value="">Todos</option>
                    <option value="INDIVIDUAL">Individual</option>
                    <option value="COMPANY">Empresa</option>
                  </select>
                </div>
                <div class="form-group">
                  <button class="btn btn-primary" onclick="loadCustomerList()">
                    Buscar
                  </button>
                </div>
              </div>
            </div>

            <div class="data-table">
              <table>
                <thead>
                  <tr>
                    <th>RUT</th>
                    <th>Nombre/Raz√≥n Social</th>
                    <th>Tipo</th>
                    <th>Email</th>
                    <th>Tel√©fono</th>
                    <th>Cr√©dito</th>
                    <th>Acci√≥n</th>
                  </tr>
                </thead>
                <tbody id="customers-tbody">
                  <!-- Resultados de b√∫squeda -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal de Personas Autorizadas -->
      <div id="authorizedBuyerModal" class="modal">
        <div class="modal-content authorized-person-modal">
          <div class="modal-header">
            <h2>üë• Personas Autorizadas</h2>
            <span class="close" onclick="closeAuthorizedBuyerModal()"
              >&times;</span
            >
          </div>

          <div class="modal-body">
            <div class="alert alert-info">
              <div class="alert-icon">‚Ñπ</div>
              <div class="alert-content">
                <div>
                  <strong>Empresa:</strong>
                  <span id="modal-company-name">-</span>
                </div>
                <div>
                  <strong>RUT:</strong> <span id="modal-company-rut">-</span>
                </div>
              </div>
            </div>

            <div class="data-table">
              <table>
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>RUT</th>
                    <th>Cargo</th>
                    <th>Email</th>
                    <th>Nivel</th>
                    <th>L√≠mite Compra</th>
                    <th>Acci√≥n</th>
                  </tr>
                </thead>
                <tbody id="authorized-persons-tbody">
                  <!-- Personas autorizadas se cargan din√°micamente -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="script.js"></script>
    <script>
      // Actualizar fecha y hora inicial
      document.addEventListener("DOMContentLoaded", function () {
        const now = new Date();
        const dateStr = now.toLocaleDateString("es-CL");
        const timeStr = now.toLocaleTimeString("es-CL", {
          hour: "2-digit",
          minute: "2-digit",
        });

        const currentDateEl = document.getElementById("current-date");
        const docDateEl = document.getElementById("doc-date");

        if (currentDateEl) {
          currentDateEl.textContent = dateStr;
        }

        if (docDateEl) {
          docDateEl.textContent = `${dateStr} - ${timeStr}`;
        }
      });
    </script>
  </body>
</html>
